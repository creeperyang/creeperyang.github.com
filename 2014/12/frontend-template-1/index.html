<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=0" />
    <meta name="author" content="Creeper Yang" />
    <meta name="description" content="Creeper's blog, focus on JavaScript/Html(5)/Css(3)" />
    <meta name="keywords" content="Creeper Yang,blog,JavaScript,html5,development">
    
    <title>前端模板分析（一） | Creeper&#39;s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
        <link rel="alternative" href="/atom.xml" title="Creeper&#39;s Blog" type="application/atom+xml">
    
    
        <link rel="icon" href="/favicon.ico">
    
    <link rel="stylesheet" href="/assets/styles/material.min.css" type="text/css">
    <link rel="stylesheet" href="/assets/styles/app.css" type="text/css">
</head>
    <body class='mdl-color--grey-100 mdl-color-text--grey-800 mdl-base'>
        <div class="mdl-layout post-page article-layout mdl-layout--fixed-header mdl-js-layout mdl-color--grey-100">
    <div class="article-ribbon">
        <a class="btn-back mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" href="javascript:history.back();">
            <i class="material-icons">arrow_back</i>
        </a>
    </div>
    <main class="article-main mdl-layout__content">
        <div class="cus-grid section--center mdl-grid">
<div class="mdl-cell mdl-cell--12-col">
    <div class="article-content mdl-color--white mdl-shadow--4dp mdl-color-text--grey-800">
        <div class="article-body">
            <div class="article-crumbs mdl-color-text--grey-500">
                
    
    <span class="category-item">Posts</span> &gt; <span class="category-item">frontend</span> &gt; <span class="category-item">前端模板分析（一）</span> 

            </div>
            <h3>前端模板分析（一）</h3>
            <p>以一段简单的代码开始：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$.ajax(&#123;<span class="comment">/*...*/</span>&#125;).done(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> list = data.list, <span class="comment">// will be like ['文艺', '博客', '摄影', '电影', '民谣', '旅行', '吉他']</span></span><br><span class="line">        tmp = <span class="string">''</span>,</span><br><span class="line">        i, </span><br><span class="line">        len = list.length;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        tmp += <span class="string">'&lt;li&gt; index: '</span> + (i + <span class="number">1</span>) + <span class="string">', content: '</span> + list[i] + <span class="string">'&lt;/li&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $(<span class="string">'#wrap'</span>).append(tmp);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>这段代码就是实现<em>根据数据拼接字符串，修改文档DOM</em>的功能，很简单，大概每个前端程序员都写过，或至少感到熟悉。</p>
<!--view-break-->
<p>但当这种代码大片大片出现时，由于逻辑和视图杂糅，拼接字符串天然就让代码难以阅读和维护。如何避免写这种代码，或者说一种解决方案——模板，就是本章的核心。</p>
<p>从苦逼的拼接字符串，到因为<code>Backbone</code>认识<code>underscore template</code>，到学习<code>angular</code>而被双向绑定惊叹，再到了解<code>React</code>等新技术，我对模板的认识也在不断加深。而且近来因为工作原因，从<code>thinkphp模板</code>到<code>django模板</code>的各种后端模板，应该说也算熟练使用。</p>
<p>从这一章开始，我打算用2～3篇文章分析前端模板，本章作为第一篇，专注于字符串模板;之后的一两篇会讲以DOM为基础的模板和两者的混合版。</p>
<h3 id="字符串模板原理">字符串模板原理</h3><p>如果网上搜一搜，前端模板引擎真不少，尤其在node出现之后，不少js模板引擎更是横跨前后端。虽然每个引擎的语法、解析方式、字符串拼接的实现可能各有不同，但关键的渲染原理仍然是<strong>动态执行javascript字符串</strong>。</p>
<h4 id="模板使用和模板特征">模板使用和模板特征</h4><p>首先假设有这样一段模板使用示例（以underscore为例）：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">id</span>=<span class="value">'container'</span>&gt;</span><span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/template"</span> <span class="attribute">id</span>=<span class="value">"tpl"</span>&gt;</span><span class="vbscript-html"><span class="xml"></span><br><span class="line">    </span><span class="vbscript">&lt;% _.<span class="keyword">each</span>(games, <span class="keyword">function</span>(game) &#123; %&gt;</span><span class="xml"></span><br><span class="line">        <span class="tag">&lt;<span class="title">li</span> <span class="attribute">class</span>=<span class="value">"item-vertical"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">a</span> <span class="attribute">href</span>=<span class="value">'/games/?uuid=</span></span></span><span class="vbscript">&lt;%= game.id %&gt;</span><span class="xml"><span class="tag"><span class="value">'</span>&gt;</span> </span><span class="vbscript">&lt;%- game.name %&gt;</span><span class="xml"> <span class="tag">&lt;/<span class="title">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">li</span>&gt;</span></span><br><span class="line">    </span><span class="vbscript">&lt;% &#125;);%&gt;</span><span class="xml"></span><br><span class="line"></span></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span>&gt;</span><span class="nimrod"></span><br><span class="line">    <span class="keyword">var</span> compiled = _.<span class="keyword">template</span>($('<span class="comment">#tpl').html());</span></span><br><span class="line">    $('<span class="comment">#container').html(compiled(data));</span></span><br><span class="line"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>可以看出，相比原始的字符串拼接，模板在可读性、可维护性和易用性上有极大提升。</p>
<p>前端模板引擎的3个特征：</p>
<ol>
<li><p>前端模板一般有3种标签，分别是</p>
<ul>
<li>js代码执行标签（evaluate tag），标签内可以执行任意js代码，如<code>&lt;% _.each(games, function(game) { %&gt;</code>;</li>
<li>插值标签（interpolate tag），输出变量的对应值，如<code>&lt;%= game.id %&gt;</code>；</li>
<li>转义标签（escape tag），输出变量前先转义，如<code>&lt;%- game.name %&gt;</code>。注意：部分模板引擎可能省略这个标签。</li>
</ul>
</li>
<li><p>模板一般可以写在<code>script</code>标签里（即内联模板），但要注意改写type，可以是<code>text/template</code>及类似的（不写或写成<code>text/script</code>的话浏览器会当成脚本解析执行）。当然，用ajax加载等其它方法也可以，模板只是含有模板标签的字符串而已。</p>
</li>
<li><p>模板引擎的接口基本一致： <code>template(tpl, data, options)</code>。如果模板和数据都传入，返回渲染好的html字符串;如果只传了模板，则返回一个模板函数，该函数接收data返回字符串。</p>
</li>
</ol>
<h4 id="以unserscore模板为例分析模板实现">以unserscore模板为例分析模板实现</h4><p>废话不多说，以常用的unserscore内置模板讲解字符串模板的实现原理。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 3种标签，可配置更改</span></span><br><span class="line">_.templateSettings = &#123; <span class="comment">// 注意`？`——非贪婪匹配</span></span><br><span class="line">    evaluate: <span class="regexp">/&lt;%([\s\S]+?)%&gt;/g</span>,</span><br><span class="line">    interpolate: <span class="regexp">/&lt;%=([\s\S]+?)%&gt;/g</span>,</span><br><span class="line">    <span class="built_in">escape</span>: <span class="regexp">/&lt;%-([\s\S]+?)%&gt;/g</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> noMatch = <span class="regexp">/(.)^/</span>; <span class="comment">// 什么都不匹配</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 需要转义的字符，转义后才能放入字符串中</span></span><br><span class="line"><span class="keyword">var</span> escapes = &#123;</span><br><span class="line">    <span class="string">"'"</span>: <span class="string">"'"</span>,</span><br><span class="line">    <span class="string">'\\'</span>: <span class="string">'\\'</span>,</span><br><span class="line">    <span class="string">'\r'</span>: <span class="string">'r'</span>,</span><br><span class="line">    <span class="string">'\n'</span>: <span class="string">'n'</span>,</span><br><span class="line">    <span class="string">'\u2028'</span>: <span class="string">'u2028'</span>,</span><br><span class="line">    <span class="string">'\u2029'</span>: <span class="string">'u2029'</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> escaper = <span class="regexp">/\\|'|\r|\n|\u2028|\u2029/g</span>;</span><br><span class="line"><span class="keyword">var</span> escapeChar = <span class="function"><span class="keyword">function</span>(<span class="params">match</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'\\'</span> + escapes[match];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Underscore模板可以处理任意分隔符，保留空白，正确处理转义（在转义标签内）</span></span><br><span class="line">_.template = <span class="function"><span class="keyword">function</span>(<span class="params">text, settings, oldSettings</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// oldSettings只是为了兼容之前版本</span></span><br><span class="line">    <span class="keyword">if</span> (!settings &amp;&amp; oldSettings) settings = oldSettings;</span><br><span class="line">    settings = _.defaults(&#123;&#125;, settings, _.templateSettings);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 组合分隔符为一个正则，分隔符是可选的</span></span><br><span class="line">    <span class="keyword">var</span> matcher = <span class="built_in">RegExp</span>([</span><br><span class="line">        (settings.escape || noMatch).source, (settings.interpolate || noMatch).source, (settings.evaluate || noMatch).source</span><br><span class="line">    ].join(<span class="string">'|'</span>) + <span class="string">'|$'</span>, <span class="string">'g'</span>); <span class="comment">// '|$'结束符在3种标签都不匹配时匹配，offset就是模板字符串长度，保证模板必然被转义处理（即source正确取到值）。</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 编译模板字符串, 正确转义字符</span></span><br><span class="line">    <span class="keyword">var</span> index = <span class="number">0</span>; <span class="comment">// 配合offset来slice出3种标签之外的字符串</span></span><br><span class="line">    <span class="keyword">var</span> source = <span class="string">"__p+='"</span>;</span><br><span class="line">    text.replace(matcher, <span class="function"><span class="keyword">function</span>(<span class="params">match, escape, interpolate, evaluate, offset</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// offset是匹配到的子串的start index，所以下面一行是把匹配子串之前的子串转义并加入source</span></span><br><span class="line">        source += text.slice(index, offset).replace(escaper, escapeChar);</span><br><span class="line">        index = offset + match.length;</span><br><span class="line">        <span class="comment">// 3种标签内的内容不同处理</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">escape</span>) &#123; <span class="comment">// 是转义，则把变量的值转义后加到source</span></span><br><span class="line">            source += <span class="string">"'+\n((__t=("</span> + <span class="built_in">escape</span> + <span class="string">"))==null?'':_.escape(__t))+\n'"</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (interpolate) &#123; <span class="comment">// 插值，则把变量的值直接加到source</span></span><br><span class="line">            source += <span class="string">"'+\n((__t=("</span> + interpolate + <span class="string">"))==null?'':__t)+\n'"</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (evaluate) &#123; <span class="comment">// 是js代码，则原样添加到source</span></span><br><span class="line">            source += <span class="string">"';\n"</span> + evaluate + <span class="string">"\n__p+='"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> match;<span class="comment">// Adobe VMs必须返回match来正确生成offset</span></span><br><span class="line">    &#125;);</span><br><span class="line">    source += <span class="string">"';\n"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果settings.variable没有指定，那么用with来限制data到本地作用域</span></span><br><span class="line">    <span class="keyword">if</span> (!settings.variable) source = <span class="string">'with(obj||&#123;&#125;)&#123;\n'</span> + source + <span class="string">'&#125;\n'</span>;</span><br><span class="line">    <span class="comment">// 完整的source</span></span><br><span class="line">    <span class="comment">// print函数可以用来代替`=`： &lt;%= a %&gt; ==&gt; &lt;% print(a) %&gt;</span></span><br><span class="line">    source = <span class="string">"var __t,__p='',__j=Array.prototype.join,"</span> +</span><br><span class="line">        <span class="string">"print=function()&#123;__p+=__j.call(arguments,'');&#125;;\n"</span> +</span><br><span class="line">        source + <span class="string">'return __p;\n'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123; <span class="comment">// 构造编译函数，此处为模板引擎核心：</span></span><br><span class="line">        <span class="comment">// 通过构造Function来动态执行js字符串</span></span><br><span class="line">        <span class="keyword">var</span> render = <span class="keyword">new</span> <span class="built_in">Function</span>(settings.variable || <span class="string">'obj'</span>, <span class="string">'_'</span>, source);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        e.source = source;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> template = <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123; <span class="comment">// 编译好的模板函数，调用只需传入数据即可</span></span><br><span class="line">        <span class="keyword">return</span> render.call(<span class="keyword">this</span>, data, _); <span class="comment">// 此处传入unserscore(_)作为参数，所以模板中可以使用unsercore的各种工具函数</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 把编译好的源码暴露到template.source，外部可以查看</span></span><br><span class="line">    <span class="keyword">var</span> argument = settings.variable || <span class="string">'obj'</span>;</span><br><span class="line">    template.source = <span class="string">'function('</span> + argument + <span class="string">')&#123;\n'</span> + source + <span class="string">'&#125;'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> template;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> escapeMap = &#123;</span><br><span class="line">    <span class="string">'&amp;'</span>: <span class="string">'&amp;amp;'</span>,</span><br><span class="line">    <span class="string">'&lt;'</span>: <span class="string">'&amp;lt;'</span>,</span><br><span class="line">    <span class="string">'&gt;'</span>: <span class="string">'&amp;gt;'</span>,</span><br><span class="line">    <span class="string">'"'</span>: <span class="string">'&amp;quot;'</span>,</span><br><span class="line">    <span class="string">"'"</span>: <span class="string">'&amp;#x27;'</span>,</span><br><span class="line">    <span class="string">'`'</span>: <span class="string">'&amp;#x60;'</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 用来转义/逆转义</span></span><br><span class="line"><span class="keyword">var</span> createEscaper = <span class="function"><span class="keyword">function</span>(<span class="params">map</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> escaper = <span class="function"><span class="keyword">function</span>(<span class="params">match</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> map[match];</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">var</span> source = <span class="string">'(?:'</span> + _.keys(map).join(<span class="string">'|'</span>) + <span class="string">')'</span>;</span><br><span class="line">    <span class="keyword">var</span> testRegexp = <span class="built_in">RegExp</span>(source);</span><br><span class="line">    <span class="keyword">var</span> replaceRegexp = <span class="built_in">RegExp</span>(source, <span class="string">'g'</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">string</span>) </span>&#123;</span><br><span class="line">        string = string == <span class="literal">null</span> ? <span class="string">''</span> : <span class="string">''</span> + string;</span><br><span class="line">        <span class="keyword">return</span> testRegexp.test(string) ? string.replace(replaceRegexp, escaper) : string;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line">_.escape = createEscaper(escapeMap);</span><br></pre></td></tr></table></figure>
<p>以上是<a href="http://underscorejs.org/underscore.js" target="_blank" rel="external">underscore.js 1.7.0</a>的前端模板相关代码。</p>
<p>通过上面的源码以及注释可以看出，模板引擎实现很简单，就是分析处理模板，然后构造一个函数动态执行js字符串。下面罗列几个需要注意的点：</p>
<ul>
<li>模板分析的正则：（1）非贪婪匹配，（2）全局匹配<code>/g</code>，（3）组合正则时添加<code>|$</code>。结合这3点，replace时就可以正确处理模板。其中非贪婪匹配保证每个标签是逐一处理（匹配<code>&lt;%str%&gt;</code>而不是<code>&lt;%str%&gt;&lt;%str%&gt;</code>）;全局则是让匹配进行到底，处理完整个模板;<code>|$</code>保证模板一定被匹配，从而保证非标签内的字符串都被转义了。</li>
<li><code>with</code>的使用。<code>with</code>在JavaScript中算是臭名昭著，但前端模板应该是普遍使用了<code>with</code>，这里必然是有原因的。这里先不说，后面会专门一个小节来讲。</li>
</ul>
<h3 id="高效的字符串模板引擎">高效的字符串模板引擎</h3><p>知道了字符串模板引擎是怎么回事后，我们更近一步，来谈谈众多前端模板引擎的性能比较，并谈谈高效的原因。</p>
<p><em>注意：这里的模板引擎仅仅指基于字符串的模板引擎，像angular之类的并不包括在内。公平而言，基于DOM的模板引擎（angular等）编译模板时会进行双向绑定，干的事远比字符串模板更多、更复杂，与字符串模板放在一起比较不合适。</em></p>
<p>参考<code>artTemplate</code>项目的测试<a href="http://aui.github.io/artTemplate/test/test-speed.html" target="_blank" rel="external">http://aui.github.io/artTemplate/test/test-speed.html</a></p>
<p><img src="http://creeper-static.qiniudn.com/stc-tpl-speed-test.png" alt="speed-test"></p>
<p>从图中可以看出，<code>artTemplate</code>的速度在主流的几款前端模板中，速度突出。那么，比较上面分析的<code>unsercore template</code>来看看<code>artTemplate</code>做了哪些特殊处理/优化。</p>
<h4 id="artTemplate模板引擎实现分析">artTemplate模板引擎实现分析</h4><p>去除一些细枝末节，直接分析artTemplate的核心实现。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compiler</span>(<span class="params">source, options</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> debug = options.debug;</span><br><span class="line">    <span class="keyword">var</span> openTag = options.openTag;</span><br><span class="line">    <span class="keyword">var</span> closeTag = options.closeTag;</span><br><span class="line">    <span class="keyword">var</span> parser = options.parser;</span><br><span class="line">    <span class="keyword">var</span> compress = options.compress;</span><br><span class="line">    <span class="keyword">var</span> <span class="built_in">escape</span> = options.escape; <span class="comment">// 以上为配置项</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> line = <span class="number">1</span>; <span class="comment">// 记录行号</span></span><br><span class="line">    <span class="keyword">var</span> uniq = &#123; <span class="comment">// flag，用来标志该变量是否在函数（最终构造的模板函数）顶部已声明</span></span><br><span class="line">        $data: <span class="number">1</span>,</span><br><span class="line">        $filename: <span class="number">1</span>,</span><br><span class="line">        $utils: <span class="number">1</span>,</span><br><span class="line">        $helpers: <span class="number">1</span>,</span><br><span class="line">        $out: <span class="number">1</span>,</span><br><span class="line">        $line: <span class="number">1</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过是否有 ''.trim 方法来判断ie6-8还是现代浏览器</span></span><br><span class="line">    <span class="keyword">var</span> isNewEngine = <span class="string">''</span>.trim; <span class="comment">// '__proto__' in &#123;&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 按是否是现代浏览器准备了2套处理方式</span></span><br><span class="line">    <span class="keyword">var</span> replaces = isNewEngine</span><br><span class="line">    ? [<span class="string">"$out='';"</span>, <span class="string">"$out+="</span>, <span class="string">";"</span>, <span class="string">"$out"</span>]</span><br><span class="line">    : [<span class="string">"$out=[];"</span>, <span class="string">"$out.push("</span>, <span class="string">");"</span>, <span class="string">"$out.join('')"</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> concat = isNewEngine</span><br><span class="line">        ? <span class="string">"$out+=text;return $out;"</span></span><br><span class="line">        : <span class="string">"$out.push(text);"</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 工具函数：print函数、include函数</span></span><br><span class="line">    <span class="keyword">var</span> print = <span class="string">"function()&#123;"</span></span><br><span class="line">    +      <span class="string">"var text=''.concat.apply('',arguments);"</span></span><br><span class="line">    +       concat</span><br><span class="line">    +  <span class="string">"&#125;"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> include = <span class="string">"function(filename,data)&#123;"</span></span><br><span class="line">    +      <span class="string">"data=data||$data;"</span></span><br><span class="line">    +      <span class="string">"var text=$utils.$include(filename,data,$filename);"</span></span><br><span class="line">    +       concat</span><br><span class="line">    +   <span class="string">"&#125;"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 准备工作：初始化headerCode、mainCode、footerCode</span></span><br><span class="line">    <span class="keyword">var</span> headerCode = <span class="string">"'use strict';"</span></span><br><span class="line">    + <span class="string">"var $utils=this,$helpers=$utils.$helpers,"</span></span><br><span class="line">    + (debug ? <span class="string">"$line=0,"</span> : <span class="string">""</span>);</span><br><span class="line">    <span class="keyword">var</span> mainCode = replaces[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">var</span> footerCode = <span class="string">"return new String("</span> + replaces[<span class="number">3</span>] + <span class="string">");"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 核心：html与逻辑语法分别处理</span></span><br><span class="line">    <span class="comment">// 首先通过openTag split成数组A; A中的元素要么是纯html字符串，要么含有closeTag</span></span><br><span class="line">    forEach(source.split(openTag), <span class="function"><span class="keyword">function</span>(<span class="params">code</span>) </span>&#123;</span><br><span class="line">        code = code.split(closeTag); <span class="comment">// 尝试用closeTag切分A中的每个元素</span></span><br><span class="line">        <span class="keyword">var</span> $<span class="number">0</span> = code[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">var</span> $<span class="number">1</span> = code[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">if</span> (code.length === <span class="number">1</span>) &#123; <span class="comment">// 说明该code是纯html字符串，$1为空</span></span><br><span class="line">            mainCode += html($<span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// 此时$0是标签之间的逻辑代码，$1是纯html字符串</span></span><br><span class="line">            mainCode += logic($<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> ($<span class="number">1</span>) &#123;</span><br><span class="line">                mainCode += html($<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 模板分析处理完毕，组合成new Function所需的source</span></span><br><span class="line">    <span class="keyword">var</span> code = headerCode + mainCode + footerCode;</span><br><span class="line">    <span class="comment">// 调试语句</span></span><br><span class="line">    <span class="keyword">if</span> (debug) &#123;</span><br><span class="line">        code = <span class="string">"try&#123;"</span> + code + <span class="string">"&#125;catch(e)&#123;"</span> + <span class="string">"throw &#123;"</span> + <span class="string">"filename:$filename,"</span> + <span class="string">"name:'Render Error',"</span> + <span class="string">"message:e.message,"</span> + <span class="string">"line:$line,"</span> + <span class="string">"source:"</span> + stringify(source) + <span class="string">".split(/\\n/)[$line-1].replace(/^\\s+/,'')"</span> + <span class="string">"&#125;;"</span> + <span class="string">"&#125;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123; <span class="comment">// 新建函数，source就是code。</span></span><br><span class="line">        <span class="keyword">var</span> Render = <span class="keyword">new</span> <span class="built_in">Function</span>(<span class="string">"$data"</span>, <span class="string">"$filename"</span>, code);</span><br><span class="line">        Render.prototype = utils; <span class="comment">// 这个很有意思，通过原型（因为utils = template.utils），让函数内部（也就是模板中）可以使用模板自带的/自己扩展的各种工具函数</span></span><br><span class="line">        <span class="keyword">return</span> Render;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        e.temp = <span class="string">"function anonymous($data,$filename) &#123;"</span> + code + <span class="string">"&#125;"</span>;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 处理 HTML 语句</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">html</span>(<span class="params">code</span>) </span>&#123;</span><br><span class="line">        line += code.split(<span class="regexp">/\n/</span>).length - <span class="number">1</span>; <span class="comment">// 记录行号</span></span><br><span class="line">        <span class="keyword">if</span> (compress) &#123; <span class="comment">// 压缩多余空白与注释</span></span><br><span class="line">            code = code.replace(<span class="regexp">/\s+/g</span>, <span class="string">' '</span>).replace(<span class="regexp">/&lt;!--[\w\W]*?--&gt;/g</span>, <span class="string">''</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (code) &#123; <span class="comment">// `$out+=`+转义后的code+`;` 或者 `$out.push(`+转义后的code+`);`</span></span><br><span class="line">            code = replaces[<span class="number">1</span>] + stringify(code) + replaces[<span class="number">2</span>] + <span class="string">"\n"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 处理逻辑语句</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">logic</span>(<span class="params">code</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> thisLine = line;</span><br><span class="line">        <span class="keyword">if</span> (parser) &#123; <span class="comment">// 逻辑语句的钩子</span></span><br><span class="line">            code = parser(code, options);<span class="comment">// artTemplate的语法转换插件钩子，如果原生语法用不到，当然，也可以自己挂进来另一套语法处理规则。</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (debug) &#123; <span class="comment">// debug时处理行号</span></span><br><span class="line">            code = code.replace(<span class="regexp">/\n/g</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="comment">// 记录行号</span></span><br><span class="line">                line++;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"$line="</span> + line + <span class="string">";"</span>;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 输出语句. 编码: &lt;%=value%&gt; 不编码:&lt;%=#value%&gt;</span></span><br><span class="line">        <span class="comment">// &lt;%=#value%&gt; 等同 v2.0.3 之前的 &lt;%==value%&gt;</span></span><br><span class="line">        <span class="comment">// 此时的code已去除openTag(&lt;%)和closeTag(%&gt;)</span></span><br><span class="line">        <span class="keyword">if</span> (code.indexOf(<span class="string">'='</span>) === <span class="number">0</span>) &#123; <span class="comment">// 验证是模板标签</span></span><br><span class="line">            <span class="keyword">var</span> escapeSyntax = <span class="built_in">escape</span> &amp;&amp; !<span class="regexp">/^=[=#]/</span>.test(code); <span class="comment">// escape为true，且标签不是 `&lt;%=#value%&gt;&lt;%==value%&gt;`（不编码直接输出） 标签</span></span><br><span class="line">            code = code.replace(<span class="regexp">/^=[=#]?|[\s;]*$/g</span>, <span class="string">''</span>); <span class="comment">// 去除残余标签（=，==，=#之类）</span></span><br><span class="line">            <span class="keyword">if</span> (escapeSyntax) &#123; <span class="comment">// 需要对内容编码</span></span><br><span class="line">                <span class="comment">// /\s*\([^\)]+\)/ ===&gt; 是否是`（something）`这种形式</span></span><br><span class="line">                <span class="comment">// 即删除括号及里面内容，例如`include('/tpl.html')`==&gt;`include`</span></span><br><span class="line">                <span class="keyword">var</span> name = code.replace(<span class="regexp">/\s*\([^\)]+\)/</span>, <span class="string">''</span>);</span><br><span class="line">                <span class="comment">// 排除 utils.* | include | print</span></span><br><span class="line">                <span class="keyword">if</span> (!utils[name] &amp;&amp; !<span class="regexp">/^(include|print)$/</span>.test(name)) &#123;</span><br><span class="line">                    code = <span class="string">"$escape("</span> + code + <span class="string">")"</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; <span class="comment">// 不编码</span></span><br><span class="line">                code = <span class="string">"$string("</span> + code + <span class="string">")"</span>;</span><br><span class="line">            &#125; </span><br><span class="line">            <span class="comment">// code = `$out+=`+`$escape/string( + code + )`+`;`</span></span><br><span class="line">            code = replaces[<span class="number">1</span>] + code + replaces[<span class="number">2</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (debug) &#123;</span><br><span class="line">            code = <span class="string">"$line="</span> + thisLine + <span class="string">";"</span> + code;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 提取模板中的变量名，然后（1）除print/include外，为变量名添加`$data`等前缀（2）把变量声明加到headerCode</span></span><br><span class="line">        forEach(getVariable(code), <span class="function"><span class="keyword">function</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">            <span class="comment">// name 值可能为空，在安卓低版本浏览器下</span></span><br><span class="line">            <span class="keyword">if</span> (!name || uniq[name]) &#123; <span class="comment">// 该name已经在变量声明中声明，直接返回</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> value; <span class="comment">// 声明模板变量</span></span><br><span class="line">            <span class="comment">// 赋值优先级: [include, print] &gt; utils &gt; helpers &gt; data</span></span><br><span class="line">            <span class="keyword">if</span> (name === <span class="string">'print'</span>) &#123;</span><br><span class="line">                value = print;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name === <span class="string">'include'</span>) &#123;</span><br><span class="line">                value = include;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (utils[name]) &#123; <span class="comment">// $escape, $string在这一步处理</span></span><br><span class="line">                value = <span class="string">"$utils."</span> + name;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (helpers[name]) &#123;</span><br><span class="line">                value = <span class="string">"$helpers."</span> + name;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                value = <span class="string">"$data."</span> + name;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 在开头中添加变量声明</span></span><br><span class="line">            headerCode += name + <span class="string">"="</span> + value + <span class="string">","</span>;</span><br><span class="line">            uniq[name] = <span class="literal">true</span>; <span class="comment">// flag设为true</span></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 可以看到，artTemplate只对输出标签做了处理，js代码标签原样输出</span></span><br><span class="line">        <span class="keyword">return</span> code + <span class="string">"\n"</span>; <span class="comment">// 返回code，code加换行</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>artTemplate的工具函数分析：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 字符串转义 ---&gt; 处理html时使用</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">stringify</span> (<span class="params">code</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"'"</span> + code</span><br><span class="line">    .replace(<span class="regexp">/('|\\)/g</span>, <span class="string">'\\$1'</span>) <span class="comment">// 单引号与反斜杠转义</span></span><br><span class="line">    .replace(<span class="regexp">/\r/g</span>, <span class="string">'\\r'</span>) <span class="comment">// 换行符转义(windows + linux)</span></span><br><span class="line">    .replace(<span class="regexp">/\n/g</span>, <span class="string">'\\n'</span>) + <span class="string">"'"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 内置的一些工具函数，可以扩展</span></span><br><span class="line"><span class="keyword">var</span> utils = template.utils = &#123;</span><br><span class="line">    $helpers: &#123;&#125;,</span><br><span class="line">    $include: renderFile,</span><br><span class="line">    $string: toString,</span><br><span class="line">    $<span class="built_in">escape</span>: escapeHTML,</span><br><span class="line">    $each: each</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> toString = <span class="function"><span class="keyword">function</span> (<span class="params">value, type</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> value !== <span class="string">'string'</span>) &#123; <span class="comment">// 如果不是字符串</span></span><br><span class="line">        type = <span class="keyword">typeof</span> value;</span><br><span class="line">        <span class="keyword">if</span> (type === <span class="string">'number'</span>) &#123; <span class="comment">// 数字则转字符串</span></span><br><span class="line">            value += <span class="string">''</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type === <span class="string">'function'</span>) &#123; <span class="comment">// 是函数则取执行结果</span></span><br><span class="line">            value = toString(value.call(value));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// 其它返回空字符串</span></span><br><span class="line">            value = <span class="string">''</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> escapeMap = &#123;</span><br><span class="line">    <span class="string">"&lt;"</span>: <span class="string">"&amp;#60;"</span>,</span><br><span class="line">    <span class="string">"&gt;"</span>: <span class="string">"&amp;#62;"</span>,</span><br><span class="line">    <span class="string">'"'</span>: <span class="string">"&amp;#34;"</span>,</span><br><span class="line">    <span class="string">"'"</span>: <span class="string">"&amp;#39;"</span>,</span><br><span class="line">    <span class="string">"&amp;"</span>: <span class="string">"&amp;#38;"</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 转义escapeMap中的五个字符为html实体</span></span><br><span class="line"><span class="keyword">var</span> escapeFn = <span class="function"><span class="keyword">function</span> (<span class="params">s</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> escapeMap[s];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// /&amp;(?![\w#]+;)/g  当且仅当 是`&amp;`且`&amp;`后面不是`[\w#]+;`</span></span><br><span class="line"><span class="comment">// /[&lt;&gt;"']/g 有`&lt;&gt;"'`4字符中任意一个</span></span><br><span class="line"><span class="comment">// 函数功能：转义`&lt;&gt;"'`以及`&amp;`（`&amp;`后面不是`[\w#]+;`——即已经转义）</span></span><br><span class="line"><span class="keyword">var</span> escapeHTML = <span class="function"><span class="keyword">function</span> (<span class="params">content</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> toString(content)</span><br><span class="line">    .replace(<span class="regexp">/&amp;(?![\w#]+;)|[&lt;&gt;"']/g</span>, escapeFn);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> isArray = <span class="built_in">Array</span>.isArray || <span class="function"><span class="keyword">function</span> (<span class="params">obj</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (&#123;&#125;).toString.call(obj) === <span class="string">'[object Array]'</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 遍历对象或数组</span></span><br><span class="line"><span class="keyword">var</span> each = <span class="function"><span class="keyword">function</span> (<span class="params">data, callback</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> i, len;        </span><br><span class="line">    <span class="keyword">if</span> (isArray(data)) &#123;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>, len = data.length; i &lt; len; i++) &#123;</span><br><span class="line">            callback.call(data, data[i], i, data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (i <span class="keyword">in</span> data) &#123;</span><br><span class="line">            callback.call(data, data[i], i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>artTemplate的变量提取：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 静态分析模板变量</span></span><br><span class="line"><span class="keyword">var</span> KEYWORDS =</span><br><span class="line">    <span class="comment">// 关键字</span></span><br><span class="line">    <span class="string">'break,case,catch,continue,debugger,default,delete,do,else,false'</span></span><br><span class="line">    + <span class="string">',finally,for,function,if,in,instanceof,new,null,return,switch,this'</span></span><br><span class="line">    + <span class="string">',throw,true,try,typeof,var,void,while,with'</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 保留字</span></span><br><span class="line">    + <span class="string">',abstract,boolean,byte,char,class,const,double,enum,export,extends'</span></span><br><span class="line">    + <span class="string">',final,float,goto,implements,import,int,interface,long,native'</span></span><br><span class="line">    + <span class="string">',package,private,protected,public,short,static,super,synchronized'</span></span><br><span class="line">    + <span class="string">',throws,transient,volatile'</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ECMA 5 - use strict</span></span><br><span class="line">    + <span class="string">',arguments,let,yield'</span></span><br><span class="line"></span><br><span class="line">    + <span class="string">',undefined'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// REMOVE_RE匹配注释（//  /**/）以及字符串（`"string"` `'string'`）</span></span><br><span class="line"><span class="keyword">var</span> REMOVE_RE = <span class="regexp">/\/\*[\w\W]*?\*\/|\/\/[^\n]*\n|\/\/[^\n]*$|"(?:[^"\\]|\\[\w\W])*"|'(?:[^'\\]|\\[\w\W])*'|\s*\.\s*[$\w\.]+/g</span>;</span><br><span class="line"><span class="comment">// 匹配[A-Za-z0-9_$]之外的</span></span><br><span class="line"><span class="keyword">var</span> SPLIT_RE = <span class="regexp">/[^\w$]+/g</span>;</span><br><span class="line"><span class="comment">// 匹配关键字 `\bkeyword\b` 匹配 `var str='str'`中的`var`</span></span><br><span class="line"><span class="keyword">var</span> KEYWORDS_RE = <span class="keyword">new</span> <span class="built_in">RegExp</span>([<span class="string">"\\b"</span> + KEYWORDS.replace(<span class="regexp">/,/g</span>, <span class="string">'\\b|\\b'</span>) + <span class="string">"\\b"</span>].join(<span class="string">'|'</span>), <span class="string">'g'</span>);</span><br><span class="line"><span class="comment">// 匹配以数字(或,数字)开头的字符串(`200s` ',200s')</span></span><br><span class="line"><span class="keyword">var</span> NUMBER_RE = <span class="regexp">/^\d[^,]*|,\d[^,]*/g</span>;</span><br><span class="line"><span class="comment">// 开头或结尾的逗号</span></span><br><span class="line"><span class="keyword">var</span> BOUNDARY_RE = <span class="regexp">/^,+|,+$/g</span>;</span><br><span class="line"><span class="keyword">var</span> SPLIT2_RE = <span class="regexp">/^$|,+/</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取变量</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getVariable</span> (<span class="params">code</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> code</span><br><span class="line">    .replace(REMOVE_RE, <span class="string">''</span>) <span class="comment">// 删除注释和字符串</span></span><br><span class="line">    .replace(SPLIT_RE, <span class="string">','</span>) <span class="comment">// js代码把[空格 ; ,]等待替换成`,`，即把合法的js代码切分</span></span><br><span class="line">    .replace(KEYWORDS_RE, <span class="string">''</span>) <span class="comment">// 删除所有的关键字</span></span><br><span class="line">    .replace(NUMBER_RE, <span class="string">''</span>) <span class="comment">// 删除以数字开头的字符串（显然不是合法的变量名）</span></span><br><span class="line">    .replace(BOUNDARY_RE, <span class="string">''</span>) <span class="comment">// 删除开头或结尾的逗号</span></span><br><span class="line">    .split(SPLIT2_RE); <span class="comment">// 以逗号分割</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/*</span><br><span class="line">    getVariable('var m = list;'); // ["m", "list"]</span><br><span class="line">*/</span></span><br></pre></td></tr></table></figure>
<p>至此，<code>artTemplate</code>的（核心）源码分析完毕，原理与<code>underscore</code>模板基本一致。</p>
<p><code>underscore</code>模板处理逻辑很简单，基本就是：html转义后输出;插值和js代码原样输出。处理逻辑中只有一个简单的<code>null/undefined</code>不输出。</p>
<p><code>artTemplate</code>模板处理更为复杂：</p>
<ol>
<li>html字符串根据设置来原样或转义输出;</li>
<li>逻辑字符串通用根据设置来原样或转义输出，但逻辑字符串中需要提取变量加到头部。</li>
</ol>
<p><code>artTemplate</code>相比<code>underscore template</code>在逻辑字符串上处理的不同也正是性能差异的关键：</p>
<ol>
<li><code>underscore template</code>几乎原样输出，这种简单处理导致了<code>with</code>的引进，或者说基于<code>with</code>才可以这样简单处理;</li>
<li><code>artTemplate</code>在逻辑字符串（js代码）中提取变量然后在顶部声明，弃用<code>with</code>。</li>
</ol>
<h4 id="artTemplate模板引擎高效原因1——with">artTemplate模板引擎高效原因1——with</h4><p>正如上面所说，抛弃<code>with</code>是artTemplate高效的最大原因。那么<code>with</code>为什么对性能影响如此之大？</p>
<p>首先确认<code>with</code>的确会显著降低js性能：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> funWith = <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">with</span>(data) &#123;</span><br><span class="line">        index = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> funNoWith = <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    data.index = <span class="number">1</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getExecuteTime</span>(<span class="params">fun, args, times</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> i = <span class="number">0</span>,</span><br><span class="line">        start = <span class="built_in">Date</span>.now();</span><br><span class="line">    <span class="keyword">for</span> (; i &lt; times; i++) &#123;</span><br><span class="line">        fun(args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Date</span>.now() - start;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> timeWith = getExecuteTime(funWith, &#123;index: <span class="number">0</span>&#125;, <span class="number">1000000</span>);</span><br><span class="line"><span class="keyword">var</span> timeNoWith = getExecuteTime(funNoWith, &#123;index: <span class="number">0</span>&#125;, <span class="number">1000000</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'timeWith'</span>, timeWith, <span class="string">' timeNoWith'</span>, timeNoWith);</span><br></pre></td></tr></table></figure>
<p><img src="http://creeper-static.qiniudn.com/stc-with-test.png" alt="测试结果"></p>
<p>如上可以看出，<code>with</code>对性能的影响巨大。</p>
<p><code>with</code>影响性能的两个原因：</p>
<h5 id="1-_影响作用域链">1. 影响作用域链</h5><p>在一个给定的执行环境中作用域链通常是不变的，但有两种情况会暂时增强作用域链（增加一级）。两种情形一个是<code>try catch</code>，另一个就是<code>with</code>。</p>
<p><code>with</code>会在当前作用域链的最底层添加一个对象（即变成作用域链上第一个对象），这个对象的所有属性都可以直接访问而不必通过<code>.</code>操作符访问，这显然很方便。但作用域链上多出的这个对象会影响（hurt）本地变量解析，因为一旦<code>with</code>语句执行，本地变量将位于<a href="http://archive.oreilly.com/pub/a/server-administration/excerpts/even-faster-websites/writing-efficient-javascript.html#scope_chain_augmentation_using_the_with_" target="_blank" rel="external">作用域链</a>上的第二个对象。</p>
<h5 id="2-_with阻止js引擎的优化编译器的优化">2. <code>with</code>阻止js引擎的优化编译器的优化</h5><p><a href="https://github.com/petkaantonov/bluebird/wiki/Optimization-killers" target="_blank" rel="external">V8引擎</a>有两个不同的编译器：通用编译器（generic）和优化编译器（optimizing）。这意味着你的js代码被编译并直接以原生代码执行。那么，这是不是说你的代码会非常快？</p>
<p>错了，（js）代码被编译为原生代码本身并不意味着性能大大提升，编译只是消除了解释器开销，如果没有优化的话，（原生）代码可能仍然很慢。注意，这里的编译指通过通用编译器编译。</p>
<p>例如：js代码<code>a + b</code>通过通用编译器编译后可能是这样子的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov eax, a</span><br><span class="line">mov ebx, b</span><br><span class="line">call RuntimeAdd</span><br></pre></td></tr></table></figure>
<p>也就是说，它只是调用了运行时的函数。如果<code>a</code>和<code>b</code>是整数的话，可能是这样的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov eax, a</span><br><span class="line">mov ebx, b</span><br><span class="line">add eax, ebx</span><br></pre></td></tr></table></figure>
<p>显然，这会极大地提高性能。通常情况下，通用编译器编译出来的就是前一种代码，而优化编译器编译出来的就是后一种代码。优化编译器编译后通常会有<code>100X</code>的性能提升。</p>
<p>那么具体到我们的<code>with</code>，<code>with</code>语句所在的函数不会被优化编译器优化。这是因为<code>with</code>块内是<code>dynamical scoped</code>，不是通常的<code>Lexical scoped</code>，这导致无法在编译时决定是绑定到哪个变量的（只能在运行时动态检测）。</p>
<p>所以，<code>with</code>非常影响性能。</p>
<h4 id="artTemplate模板引擎高效原因2——字符串相加">artTemplate模板引擎高效原因2——字符串相加</h4><p>可以看到artTemplate中有<code>array.push</code>和一般的<code>+=</code>两种字符串相加方式。</p>
<p>很多人误以为数组 push 方法拼接字符串会比 += 快，但这仅仅是 IE6-8 的浏览器下。实测表明现代浏览器使用 += 会比数组 push 方法快，而在 v8 引擎中，使用 += 方式比数组拼接快 4.7 倍。所以 artTemplate 根据 javascript 引擎特性采用了两种不同的字符串拼接方式。</p>
<h3 id="结束语">结束语</h3><p>本篇博文中，我分析了<code>underscore template</code>和<code>artTemplate</code>两个模板引擎，借助这两个模板引擎，基于字符串的模板引擎的特征和原理应该清楚了。</p>
<p>我们可以看到<code>artTemplate</code>对于<code>underscore template</code>在性能上的优化，但模板非常耗费时间的一点——<code>dom.innerHTML = compiledString</code>，基于字符串的模板引擎都没有涉及到（也无法涉及，因为基于字符串的模板从始至终都只是字符串的处理）。</p>
<p>另外，当数据变化时，字符串模板引擎只是不断的重复<code>dom.innerHTML = compiledString</code>，而这里有很大的性能浪费，毕竟大部分情况不需要替换所有dom元素，可能只需要更新文本而已。而一旦替换全部dom元素，那么事件等等也都需要重新绑定。</p>
<p>为了解决这些问题，第二代模板——基于dom的模板如angularjs、avalonjs等等出现了，前端模板系列的下一篇的重点就将关注它们的实现原理。</p>

        </div>
        
            <section id="comments">
                <div id="disqus_thread">
                    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                </div>
            </section>
        
    </div>
    <nav class="pagination-bar mdl-color-text--grey-50">
    
        <a href="/2015/01/JavaScript-dynamic-scope-vs-static-scope/" class="pagination__button">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900">
                <i class="material-icons">arrow_back</i>
            </button>
            Newer
        </a>
    
    <div class="section-spacer"></div>
    
        <a href="/2014/11/javascript-base-about-scoping-and-precompile/" class="pagination__button">
            Older
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>
</div>
        </div>
    </main>
</div>

    <script>
        var disqus_shortname = 'ghblog-cp'; 
            var disqus_url = 'http://creeperyang.github.io/2014/12/frontend-template-1/'; 
        (function() {
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>

        <script src="/assets/scripts/material.min.js" type="text/javascript"></script>
        
<!-- Google Analytics -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-63704729-1', 'auto');
ga('send', 'pageview');
</script>
<!-- End Google Analytics -->

    </body>
</html>